<!DOCTYPE html>
<html>
<head>
    <title>Tạo đơn hàng</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Tạo đơn hàng</h1>
    <form method="POST" action="/taodonhang">
        <input type="text" name="search" placeholder="Tìm kiếm sản phẩm">
        <input type="submit" value="Tìm kiếm">
    </form>
    {% if data.list_san_pham %}
        <table>
            <tr>
                <th>Tên hàng</th>
                <th>Số lượng</th>
                <th>Đơn giá</th>
                <th>Thành tiền</th>
            </tr>
            {% for san_pham in data.list_san_pham %}
                <tr onclick="showInputRow(this)">
                    <td>{{ san_pham.TenHang }}</td>
                    <td>{{ san_pham.DonGia }}</td>
                    <td class="hidden">
                        <input type="number" name="so_luong" min="1" required>
                    </td>
                    <td class="hidden">0</td>
                </tr>
            {% endfor %}
        </table>
    {% else %}
        <p>Không tìm thấy sản phẩm nào.</p>
    {% endif %}
    <p>Tổng tiền: <span id="tong_tien">0</span></p>
    <input type="hidden" name="tong_tien" value="0">
    <input type="submit" value="Tạo đơn hàng">

    <script>
        function showInputRow(row) {
            var quantityCell = row.querySelector('td:nth-child(3)');
            var totalCell = row.querySelector('td:nth-child(4)');

            quantityCell.classList.remove('hidden');
            totalCell.classList.remove('hidden');
        }

        document.addEventListener("DOMContentLoaded", function() {
            var rows = document.querySelectorAll("tr:not(:first-child)");

            rows.forEach(function(row) {
                var quantityInput = row.querySelector("input[name='so_luong']");
                var totalCell = row.querySelector("td:nth-child(4)");

                quantityInput.addEventListener("input", function() {
                    var quantity = parseInt(quantityInput.value);
                    var price = parseFloat(row.cells[1].textContent);
                    var total = quantity * price;

                    totalCell.textContent = total.toFixed(0);

                    calculateTotal();
                });
            });
        });

        function calculateTotal() {
            var totalCells =document.querySelectorAll("td:nth-child(4)");
            var total = 0;

            totalCells.forEach(function(cell) {
                total += parseInt(cell.textContent);
            });

            document.getElementById("tong_tien").textContent = total.toFixed(0);
            document.querySelector("input[name='tong_tien']").value = total.toFixed(0);
        }
    </script>
</body>
</html>